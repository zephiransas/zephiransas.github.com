
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>zephiransasのチラシの裏</title>
  <meta name="author" content="Takafumi Yoshida (@zephiransas)">

  
  <meta name="description" content="Spring BootのプロジェクトでもSASSが書きたい！という欲望から、Gulpを使ってSASSをコンパイルするようにしました。 基本Gulpでやってるので、出力先だけ変えれば、特にSpring Bootには関係ない気もしますが・・・ npmは既にインストールしてある前提で。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://zephiransas.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="zephiransasのチラシの裏" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41139724-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">zephiransasのチラシの裏</a></h1>
  
    <h2>とあるJava/Rubyプログラマのメモ代わりブログ</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="zephiransas.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/04/05/gulp-sass/">Spring BootのCSSをGulpで管理する</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-04-05T16:13:17+09:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>4:13 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Spring BootのプロジェクトでもSASSが書きたい！という欲望から、Gulpを使ってSASSをコンパイルするようにしました。</p>

<p>基本Gulpでやってるので、出力先だけ変えれば、特にSpring Bootには関係ない気もしますが・・・</p>

<p>npmは既にインストールしてある前提で。</p>

<h2>フォルダの構成と基本方針</h2>

<p>フォルダ構成は以下のようなイメージ。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>├── assets
</span><span class='line'>│   └── stylesheets
</span><span class='line'>│       └── application.scss
</span><span class='line'>├── gulpfile.js
</span><span class='line'>├── package.json
</span><span class='line'>└── src
</span><span class='line'>    └── main
</span><span class='line'>        └── resources
</span><span class='line'>            └── static
</span><span class='line'>                └── css
</span><span class='line'>                    ├── maps
</span><span class='line'>                    │   └── application.css.map
</span><span class='line'>                    └── application.css
</span></code></pre></td></tr></table></div></figure>


<p>assets/stylesheets以下にSASSを配置し、これをGulpでコンパイル。</p>

<p>出力先をSpring BootのCSS配備先 <code>src/main/resources/static/css</code> にして、これをThymeleafから参照する、という方針です。</p>

<h2>必要なパッケージをインストールする</h2>

<p>まずは必要なパッケージをnpmでインストールしていきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>npm init
</span><span class='line'><span class="o">(</span>以降、全てデフォルトで<span class="o">)</span>
</span><span class='line'><span class="nv">$ </span>npm install --save-dev gulp gulp-sass gulp-sourcemaps gulp-minify-css gulp-plumber
</span></code></pre></td></tr></table></div></figure>


<p>これでpackage.jsonが作成され、node_modulesに依存ライブラリがインストールされます。node_modulesはgitignoreしておくといいでしょう。</p>

<h2>gulpfile.jsを作成する</h2>

<p>SASSをコンパイルできるようGulpのタスクを定義します。</p>

<figure class='code'><figcaption><span>gulpfile.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">gulp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">sass</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-sass&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">sourcemaps</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-sourcemaps&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">minifyCss</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-minify-css&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">plumber</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-plumber&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;sass&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;assets/stylesheets/*.scss&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">plumber</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sourcemaps</span><span class="p">.</span><span class="nx">init</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sass</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">minifyCss</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sourcemaps</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;./maps&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">&#39;src/main/resources/static/css&#39;</span><span class="p">))</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>まずscssファイルの置き場所を <code>gulp.src('assets/stylesheets/*.scss')</code> としてassets/stylesheetsディレクトリに設定します。</p>

<p><code>.pipe(sass())</code>でSASSのコンパイル、<code>.pipe(minifyCss())</code>でCSSの圧縮をしています。</p>

<p>圧縮したCSSだと、元のSASSでの場所がわからなくなるので <code>.pipe(sourcemaps.write('./maps'))</code>でmapファイルを作成します。</p>

<p><code>sourcemaps.write()</code>はデフォルトだとコンパイルされたcss内部にインラインでmapを書き込むので、別途mapsディレクトリにmapファイルを書き込むよう設定しておきます。こうしておくことでChromeなどのDeveloper toolで見たときにSASSの場所が分かるようになります。</p>

<p>最後に <code>.pipe(gulp.dest('src/main/resources/static/css'))</code>でCSS出力しています。</p>

<p>設定したタスクを実行します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gulp sass
</span></code></pre></td></tr></table></div></figure>


<p>これでCSSが出力されますので、あとはThymeleaf側から</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">href=</span><span class="s">&quot;@{/css/application.css}&quot;</span><span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>として参照できます。</p>

<h2>SASSを分割したい</h2>

<p>よくあるケースとして、画面単位でSASSを分け、最終的なCSSでは1つにまとめてしまいたい、というケースがあります。
例えば、以下のようなイメージ。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>assets
</span><span class='line'>└── stylesheets
</span><span class='line'>    ├── modules &lt;- 各画面ごとのSASS
</span><span class='line'>    │   ├── _hoge.scss
</span><span class='line'>    │   └── _fuga.scss
</span><span class='line'>    └── application.scss &lt;- modulesを全てimportしたい
</span></code></pre></td></tr></table></div></figure>


<p>こういった時にはgulp-sass-bulk-importが便利です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>npm install --save-dev gulp-sass-bulk-import
</span></code></pre></td></tr></table></div></figure>


<p>としてgulp-sass-bulk-importをインストールした後、gulpfile.jsを修正します。</p>

<figure class='code'><figcaption><span>gulpfile.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">sassBulk</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-sass-bulk-import&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;sass&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;assets/stylesheets/*.scss&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">plumber</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sourcemaps</span><span class="p">.</span><span class="nx">init</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sassBulk</span><span class="p">())</span> <span class="err">#</span> <span class="err">追加</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sass</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">minifyCss</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sourcemaps</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;./maps&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">&#39;src/main/resources/static/css&#39;</span><span class="p">))</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>あとはapplication.scssで</p>

<figure class='code'><figcaption><span>application.scss</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="k">@import</span> <span class="s2">&quot;modules/*&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>とすることで、modules内のSASSを含めて、CSSがコンパイルされます。</p>

<p>注意点として、modules以下のSASSファイルは、プレフィックスとしてアンダーバーが付与されています。付与しない場合は、modules以下のSASSも普通にコンパイルの対象になり、そのままdestに出力されてしまうので、これを防止するため、アンダーバーを付与しています。</p>

<h2>Bootstrapを使いたい</h2>

<p>まずBoostrapをnpmでインストールします。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>npm install --save-dev bootstrap@4.0.0-alpha.4
</span></code></pre></td></tr></table></div></figure>


<p>これでnode_modulesにBootstrapがインストールされたので、これをGulpから参照できるようgulpfile.jsを修正します。</p>

<figure class='code'><figcaption><span>gulpfile.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;sass&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;assets/stylesheets/*.scss&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">plumber</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sourcemaps</span><span class="p">.</span><span class="nx">init</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sassBulk</span><span class="p">())</span> <span class="err">#</span> <span class="err">追加</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sass</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">includePaths</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;./node_modules/bootstrap/scss&#39;</span><span class="p">]</span>   <span class="err">#</span> <span class="err">追加</span>
</span><span class='line'>    <span class="p">}))</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">minifyCss</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sourcemaps</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;./maps&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">&#39;src/main/resources/static/css&#39;</span><span class="p">))</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>あとはapplication.scssで</p>

<figure class='code'><figcaption><span>application.scss</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>とするだけです。SASSのコンパイルを実行すると、application.cssにBootstrapのcssが含まれていることがわかります。</p>

<h2>参考など</h2>

<ul>
<li><a href="http://qiita.com/steelydylan/items/37aa028fa11046cf4f51">gulpの設定を簡単に行える、gulpfile generatorを作りました。</a></li>
<li><a href="http://steelydylan.github.io/gulp-generator/">gulp generator</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/03/10/ciecleci-and-gradle/">CircleCIでGradleのテストを並列実行する</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-03-10T09:32:48+09:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>9:32 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>現在開発を行っているプロジェクトでは、Spring Bootを使って開発を行っているのですが、そこでのテストをCI環境で実行できるよう設定を行ったので、その手順を書いておきます。</p>

<h2>CircleCIで普通にテストできるようにする</h2>

<p>最初は並列ではなく、1つのコンテナを使ってCircleCIでテストできるように設定を行います。まずcircle.ymlを以下のように準備。</p>

<figure class='code'><figcaption><span>circle.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">machine</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">java</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">openjdk8</span>
</span><span class='line'>  <span class="l-Scalar-Plain">timezone</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Asia/Tokyo</span>
</span><span class='line'>  <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">_JAVA_OPTIONS</span><span class="p-Indicator">:</span> <span class="s">&quot;-Xms512m</span><span class="nv"> </span><span class="s">-Xmx1024m&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">GRADLE_OPTS</span><span class="p-Indicator">:</span> <span class="s">&#39;-Dorg.gradle.jvmargs=&quot;-Xmx1024m</span><span class="nv"> </span><span class="s">-XX:+HeapDumpOnOutOfMemoryError&quot;&#39;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">post</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sudo service postgresql stop</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">dependencies</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">override</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./gradlew testClasses</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">post</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mysql -e &#39;create database [データベース名];&#39;</span>
</span><span class='line'>    <span class="c1"># flywayなどでのマイグレーション</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">override</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./gradlew test</span>
</span><span class='line'>  <span class="l-Scalar-Plain">post</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mkdir -p $CIRCLE_TEST_REPORTS/junit/ &amp;&amp; find . -type f -regex &quot;.*/build/test-results/.*xml&quot; -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;</span><span class="p-Indicator">:</span>
</span></code></pre></td></tr></table></div></figure>


<h3>メモリ割り当てについて</h3>

<p>machine.environmentでJAVA_OPTIONSに"-Xms512m -Xmx1024m"を指定しています。これはCircleCIでは1つのコンテナには4Gのメモリが割当られており、その上限をこえると、コンテナがフリーズして、10分経過するとテスト失敗になるという現象に対応するためです。合わせてGRADLE_OPTSにも同様の設定をおこなっています。</p>

<p>このあたりの設定も状況によっては増やせる場合もありますので、テストを実行しながら、調整してみてください。</p>

<ul>
<li><a href="https://circleci.com/docs/1.0/oom/">Your build hit the 4G memory limit</a></li>
</ul>


<h3>使わないデータベースを止める</h3>

<p>CircleCIではデフォルトでPostgreSQLとMySQLがインストールされたコンテナが準備されます。machine.postで使わないデータベースを止めることで、貴重なメモリの使用量を抑えることができます。</p>

<p>今回テスト対象のデータベースはMySQLですので、PostgreSQLを止めてメモリを節約します。</p>

<h3>dependenciesでライブラリをダウンロードしておく</h3>

<p>CircleCIではdatabaseサイクルが終わったタイミングで、次回のビルドを高速に実行できるよう、依存ライブラリなどをキャッシュする仕組みがあります。</p>

<p>しかしGradleではテストを実行する直前まで依存ライブラリはダウンロードされず、通常のままだと依存ライブラリをキャッシュに含めることができません。</p>

<p>そこでdependencies.overrideにてtestClassesタスクを実行しておきます。こうすることで、依存ライブラリがダウンロードされ、databaseサイクル終了後にキャッシュが作成されるようになります。</p>

<h3>Spring Bootのprofileはciにする</h3>

<p>CircleCIで動かす場合はデータベースの接続先が開発環境などとは変わるはずですので、CircleCI専用のapplication.ymlをapplication-ci.ymlとして作成します。</p>

<figure class='code'><figcaption><span>application-ci.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">spring</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">profiles</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">active</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ci</span>
</span><span class='line'>  <span class="l-Scalar-Plain">datasource</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">jdbc:mysql://localhost:3306/{データベース名}</span>
</span><span class='line'>    <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ubuntu</span>
</span><span class='line'>    <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">driverClassName</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">com.mysql.jdbc.Driver</span>
</span></code></pre></td></tr></table></div></figure>


<p>CircleCIのMySQLには上記の設定で接続可能です。次にテスト実行時に</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">SPRING_PROFILES_ACTIVE</span><span class="o">=</span>ci ./gradlew <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>とすることで、application-ci.ymlのデータベース接続情報を使用するようになります。</p>

<h3>テスト実行結果を集約する</h3>

<p>test.postにて、テスト結果のxmlを$CIRCLE_TEST_REPORTSにコピーしておきます。こうすることで、CircleCIの画面からテスト結果を簡単に見ることができます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">test</span>:
</span><span class='line'>  post:
</span><span class='line'>    - mkdir -p <span class="nv">$CIRCLE_TEST_REPORTS</span>/junit/ <span class="o">&amp;&amp;</span> find . -type f -regex <span class="s2">&quot;.*/build/test-results/.*xml&quot;</span> -exec cp <span class="o">{}</span> <span class="nv">$CIRCLE_TEST_REPORTS</span>/junit/ <span class="se">\;</span>:
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://circleci.com/docs/1.0/test-metadata/#gradle-junit-results">Collecting test metadata</a></li>
</ul>


<h2>並列テストが実行できるようにする</h2>

<p>次にCircleCI+Gradleで並列テストをすることを考えてみます。</p>

<p>一般的に並列テストを行う場合は、テスト対象のクラスを取得し、これをノードそれぞれに均等に割り振ることでテストを分散して実行します。</p>

<p>Gradleにはデフォルトではテスト対象のクラスフィルタリングする昨日はあるのですが、対象クラスを個別に指定する方法はありません。</p>

<p><a href="https://docs.gradle.org/current/userguide/java_plugin.html#test_filtering">https://docs.gradle.org/current/userguide/java_plugin.html#test_filtering</a></p>

<p>ですので今回はGradle実行時に-Pオプションを指定し、以下のようにして対象クラスを一括して渡す方法を採用しています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./gradlew <span class="nb">test</span> -PtestFiles<span class="o">=</span>./src/test/java/com/example/HogeTest ./src/test/java/com/example/FugaTest ....以下テスト対象クラスを列挙
</span></code></pre></td></tr></table></div></figure>


<p>まずは、このオプションを組み立てつつ、gradleｗ実行する専用のシェルスクリプト（circleci.sh)を準備します。</p>

<figure class='code'><figcaption><span>circleci.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">testFiles</span><span class="o">=</span><span class="k">$(</span>find ./src/test -name *Test.java <span class="p">|</span> sort <span class="p">|</span> awk <span class="s2">&quot;NR % ${CIRCLE_NODE_TOTAL} == ${CIRCLE_NODE_INDEX}&quot;</span><span class="k">)</span>
</span><span class='line'><span class="nb">echo</span> <span class="nv">$testFiles</span>
</span><span class='line'><span class="nv">SPRING_PROFILES_ACTIVE</span><span class="o">=</span>ci ./gradlew :webapp:test -PtestFiles<span class="o">=</span><span class="s2">&quot;$testFiles&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>CircleCI上でビルドに使用しているノード数は環境変数CIRCLE_NODE_TOTALから、自身のノード番号は環境変数CIRCLE_NODE_INDEXから取得できますので、これをawkから利用しつつ、テスト対象クラスを分散させます。</p>

<p>次にbuild.gradle内では-Pオプションで渡されたtestFilesのみをテスト対象にするよう、includeTestsMatchingを使って設定を行います。</p>

<figure class='code'><figcaption><span>build.gradle</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">test</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span>project.hasProperty<span class="o">(</span><span class="s2">&quot;testFiles&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>      ArrayList <span class="nv">files</span> <span class="o">=</span> project.getProperties<span class="o">()</span>.get<span class="o">(</span><span class="s2">&quot;testFiles&quot;</span><span class="o">)</span>
</span><span class='line'>              .replaceAll<span class="o">(</span><span class="s2">&quot;./src/test/java/&quot;</span>, <span class="s2">&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>              .replaceAll<span class="o">(</span><span class="s2">&quot;/&quot;</span>, <span class="s2">&quot;.&quot;</span><span class="o">)</span>
</span><span class='line'>              .replaceAll<span class="o">(</span><span class="s2">&quot;.java&quot;</span>, <span class="s2">&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>              .split<span class="o">(</span><span class="s2">&quot;\\s+&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="k">for</span><span class="o">(</span>String file : files<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          println file
</span><span class='line'>          filter <span class="o">{</span>
</span><span class='line'>              includeTestsMatching file
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>こうすることで-PtestFilesで指定されたもののみ、テストを行うことができます。</p>

<p>最後に、並列実行できるようcircle.ymlを修正します。</p>

<figure class='code'><figcaption><span>circle.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">override</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./circleci.sh</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">parallel</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">post</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mkdir -p $CIRCLE_TEST_REPORTS/junit/ &amp;&amp; find . -type f -regex &quot;.*/build/test-results/.*xml&quot; -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">parallel</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>テストは先ほど作成したcircle.shを実行するようにしparallel: trueを付与して並列実行するようにします。<strong>parallel: trueはインデント4つであることに注意！</strong></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/31/schfeslogsvr/">スクフェス・ログサーバをつくった</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-12-31T12:47:59+09:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2016</span></span> <span class='time'>12:47 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>今日は大晦日ですね。年末ですが今年も例によって、コード書いたりプラモ作ったり、普段の連休と同じくダラダラ過ごしております。</p>

<p>ところで今年の<a href="http://www.adventar.org/calendars/1360">ラブライブ！アドベントカレンダー</a>はチェックしましたか？
自分も20日目に<a href="https://zephiransas.goat.me/3OsFK6X7">劇場版ラブライブとμ’ｓメンバーのその後</a>というタイトルでエントリしてます。
今年はその他にも、さまざまな視点から見た素晴らしいエントリがたくさん集まってますので、ラブライバーならぜひチェックしてみてください。</p>

<p>で、22日目のエントリには<a href="https://twitter.com/hideo54">@hideo54</a>さんの<a href="https://blog.hideo54.com/archives/591">スクフェスのライブスコアを取得する”schfeslog”を作った話</a>というのがあります。
これはnodeで建てたプロキシを使って、スクフェスがサーバに送信してる通信内容をみて、ライブのプレイ結果をツイートすることができるツールです。</p>

<ul>
<li>hideo54/schfeslog - <a href="https://github.com/hideo54/schfeslog">https://github.com/hideo54/schfeslog</a></li>
</ul>


<p>これをみて「お、ツイートできるんなら、外部サーバにも送信できるんじゃね？」ってことで、早速コードを書いてみました。</p>

<p>まずはschfeslog側に外部サーバへの通信機能を実装しています。該当するPull Requestは<a href="https://github.com/hideo54/schfeslog/pull/4">こちら</a>。単純にプレイデータをJSON形式にして、設定でされたサーバにPOSTするだけです。</p>

<p>これを受信するサーバはこちら。</p>

<ul>
<li>zephiransas/schfeslogsvr - <a href="https://github.com/zephiransas/schfeslogsvr">https://github.com/zephiransas/schfeslogsvr</a></li>
</ul>


<p>送信されたプレイデータを一覧で見ることもできます。ちなみに私のプレイデータがこちら</p>

<ul>
<li>schfeslog - <a href="http://schfeslog.herokuapp.com/">http://schfeslog.herokuapp.com/</a></li>
</ul>


<p>見た目とかは、もうちょっと改善したいところです・・・</p>

<p>最近、ちょっとJavaの案件をやってるせいもあって、真面目にSpring Bootで書いています。こういったRESTなアプリケーションを作るにはSpring Bootはとても簡単でいいですね。</p>

<p>サーバ側は簡単に自分用に環境を作れるよう、Deploy to Herokuボタンも準備してますので、興味のあるかたはschfeslogと一緒に、ぜひ試してみてください。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/18/gbdaitokai2016/">合同勉強会2016に参加してきた</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-12-18T21:21:31+09:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>9:21 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>このエントリは<a href="http://www.adventar.org/calendars/1580">大都会岡山アドベントカレンダー2016</a>の18日目のエントリです。</p>

<p>昨日のエントリは <a href="https://twitter.com/DAI199">たがみだいき</a>さんの「<a href="http://tagamidaiki.com/railsgirlsokayama-2nd/">RailsGirlsOkayama 2ndを2月25日26日に開催する予定です！</a>」でした。
<a href="http://railsgirls.com/okayama2015.html">去年の第1回</a>には、自分もコーチとして参加させてもらいましたが、そこから新たに岡山に女性エンジニアのコミュニティができ、それが主体となってRailsGirlsをやる、というのは素晴らしいことだと思います。きっとイベントも大成功することでしょう。</p>

<p>先日、毎年恒例となった合同勉強会と忘年会議が開催されました。</p>

<p>例年のように県内だけでなく県外からも多くのかたに参加していただき、大変よいイベントになったのではないでしょうか。</p>

<p>例によって写真を撮ってますのでこちらからどうぞ。</p>

<p><a href="https://www.flickr.com/photos/zephiransas/sets/72157674062172594/">合同勉強会&amp;忘年会議2016</a></p>

<p>個人的に今回のベストトーカー（not ベストストーカー）を上げたいのは、<a href="https://twitter.com/samuneP">SamuneP</a>さんの「ゲーム会社経営ゲーム」。
とにかく高い技術力を武器に、ちょっと尻込みしちゃうような案件をやってるハナシで、とにかく「今の時代にこんな人がいるのか？！」と驚きの連続でした。その凄さをみんなもうまく言語化できずに</p>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">めちゃくちゃ面白い話聞いてるけど、上手に実況できる気がしないwww <a href="https://twitter.com/hashtag/gbdaitokai?src=hash">#gbdaitokai</a></p>&mdash; シン・ダイクシー Plus (@daiksy) <a href="https://twitter.com/daiksy/status/809990570441523200">2016年12月17日</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>




<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">なんか…うまいこといわれへんけど「この人、天才ちゃうか？」と思わされるｗ <a href="https://twitter.com/hashtag/gbdaitokai?src=hash">#gbdaitokai</a></p>&mdash; 三浦一仁(本読めるようになりたい) (@kazuhito_m) <a href="https://twitter.com/kazuhito_m/status/809990766495862784">2016年12月17日</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>




<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">つよい(つよい) <a href="https://twitter.com/hashtag/gbdaitokai?src=hash">#gbdaitokai</a></p>&mdash; ⊇ﾅﾆﾚﾆω (@kotanin) <a href="https://twitter.com/kotanin/status/809990832128262144">2016年12月17日</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>などなど、人のボキャブラリーを著しく低下させる作用があったようですw</p>

<p>さて、次は来年のオープンセミナーです。こちらも面白いセッションをたくさん用意できるよう、誠意準備中ですので、ぜひご参加ください！</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/23/maven-wrapper/">Maven Wrapperを使ってプロジェクトで使うMavenのバージョンを指定する</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-05-23T16:34:12+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2016</span></span> <span class='time'>4:34 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Javaでの開発において、ライブラリのバージョン管理にMavenを用いているところはたくさんあると思います。</p>

<p>しかし、pom.xmlを使って各ライブラリのバージョンを管理していても、各開発者が使うMavenのバージョンを固定することはできません。</p>

<p>プロジェクトで使うMavenのバージョンを固定したい！そんな場合に使えるのがMaven Wrapperです。</p>

<ul>
<li>takari/maven-wrapper -　<a href="https://github.com/takari/maven-wrapper">https://github.com/takari/maven-wrapper</a></li>
</ul>


<h2>導入方法</h2>

<p>導入方法は至って簡単。</p>

<p>maven wrapperを適用したいプロジェクトに移動して、以下のコマンドを発行するだけ。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mvn -N io.takari:maven:wrapper
</span></code></pre></td></tr></table></div></figure>


<p>これだけで、プロジェクトに以下のファイルが追加されます。</p>

<ul>
<li>mvnw - Maven Wrapper経由でmavenを実行するためのファイル</li>
<li>mvnw.cmd - mvnwのWindows版。Windowsで使う場合はこっちを使いましょう。</li>
<li>.mvnディレクトリ - maven wraperがダウンロードしてきたMavenのバイナリとかが入ってる</li>
</ul>


<p>上記のコマンドだと実行時の最新のバージョンが使用されるので、バージョンを指定したい場合はオプションで</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mvn -N io.takari:maven:wrapper -Dmaven<span class="o">=</span>3.3.1
</span></code></pre></td></tr></table></div></figure>


<p>としてやりましょう。以降は今まで</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mvn clean
</span><span class='line'>mvn package
</span></code></pre></td></tr></table></div></figure>


<p>としていたのをmvnwコマンドに置き換えるだけで</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./mvnw clean
</span><span class='line'>./mvnw package
</span></code></pre></td></tr></table></div></figure>


<p>固定されたバージョンをMavenを利用することができます。</p>

<h1>.gitignoreの設定</h1>

<p>~~ Gitなどのバージョン管理にはmvnwとmvnw.cmdのみコミット対象とし、<strong>.mvnディレクトリはコミット対象外</strong>にしましょう。 ~~</p>

<p>はい、これウソでしたorz</p>

<p>正しくは「.mvnディレクトリもコミットしましょう」です。</p>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">YOSHIDAさん慣れないジャバやるから</p>&mdash; やっぱりおいしい木村屋のパン (@razon) <a href="https://twitter.com/razon/status/734898775873884160">2016年5月24日</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>はい、その通りですね（真顔</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/24/past-present-and-future/">Past, Present and Future</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-24T00:00:00+09:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:00 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>これは<a href="http://luna3.heteml.jp/etc/entry-12.html">大都会アドベントカレンダー</a>24日目の記事です。</p>

<p>昨日は<a href="https://twitter.com/yantona">@yantonaさん</a>の<a href="http://luna3.heteml.jp/etc/entry-12.html">君は「玉野音頭」を知っているか</a>でした。</p>

<p>不覚にも自分は知りませんでした・・・瀬戸大橋音頭なら・・・！</p>

<p>実は今年の大都会アドベントカレンダー、12日目のきよくらさんが自分とIT勉強会とのかかわり合いについて書かれていて、これにインスパイアされたので、便乗して自分が岡山のIT勉強会に関わって、岡山Javaユーザ会を開催するようになるまでを、まとめてみようと思います。</p>

<h1>岡山でJavaの勉強会をスタートするまで</h1>

<h2>2010年</h2>

<p>2010年、当時自分は岡山にある小さなSIerで仕事をしていました。当時やっていたのは主にJavaを使ってのWeb開発で、Apache,Seasarなどのオープンソースソフトウェアを好んで使っていました。小さな会社だったこともあり、新しい技術の導入には比較的寛容な環境だったかもしれません。</p>

<p>そんなとき、ネットで偶然見かけたのがオープンラボ岡山でした。勉強会についてはほとんど知らなかったし、それほど興味も無かったのですが、偶然Seasarの作者であるひがやすおさんが、岡山に来られるということだけで参加しに行きました。</p>

<ul>
<li>第15回オープンラボ岡山 - <a href="http://openlab.okaya.ma/wiki.cgi?page=%CA%D9%B6%AF%B2%F1%2F%C2%E8015%B2%F3">http://openlab.okaya.ma/wiki.cgi?page=%CA%D9%B6%AF%B2%F1%2F%C2%E8015%B2%F3</a></li>
</ul>


<p>この時にはSeasarの開発も一時期よりは落ち着いてきて、ひがさん自身も「これからはクラウドだ！GAEだ！Slim3だ！」と、Slim3についての話をされていたことを覚えています。</p>

<p>同時に年末だったこともあり、忘年会議も開催されていますが、これには参加してませんでした・・・</p>

<p>思えば、ここが最初のスタートです。</p>

<h2>2011年</h2>

<p>去年参加したオープンラボをキッカケに、2011年からは勉強会にも積極的に参加するようになりました。</p>

<p>このころはオープンラボ岡山は月に1度のペースで開催されていましたので、ほぼ毎月参加していたように思います。そしてそのなかで、いろいろな人から、技術に関する話を聞くうちに、勉強会に参加する面白さを感じることができるようになったと思います。</p>

<p>当時は勉強会に登壇する人全てが、雲の上の人のように感じていましたね。</p>

<p>それと同時に「人の話を聞いてるだけじゃなく、自分も話せるようになって、みんなに喜んで欲しい」という気持ちも同時に芽生え始めたように思います。</p>

<p>そして転機は第19回オープンラボ岡山のときです。</p>

<ul>
<li>第19回オープンラボ岡山 - <a href="http://openlab.okaya.ma/wiki.cgi?page=%CA%D9%B6%AF%B2%F1%2F%C2%E8019%B2%F3">http://openlab.okaya.ma/wiki.cgi?page=%CA%D9%B6%AF%B2%F1%2F%C2%E8019%B2%F3</a></li>
</ul>


<p>この回はJava特集ということで、当時は日本オラクル所属だった寺田佳央さんと、RedHatの木村貴由さんのお二人からJavaについての話を聞きました。そこで寺田さんはGlassFishの話をされたのですが、これが個人的に一番興味をそそられたので、その後も個人的にいろいろ調べ、以下のブログを書きました。</p>

<ul>
<li>Glassfish 3.1の自己増殖クラスタを試す - <a href="http://d.hatena.ne.jp/zephiransas/20110707/1310027466">http://d.hatena.ne.jp/zephiransas/20110707/1310027466</a></li>
</ul>


<p>このエントリを書いたことをキッカケに、オープンラボ岡山の常連であり、隣国？である福山で「オープンラボ備後」を主催されていた、Yさんから「GlassFishの話してみない？」という依頼がありました。そして第10回オープンラボ備後で初登壇することになります。</p>

<ul>
<li>第10回オープンラボ備後 - <a href="https://sites.google.com/site/openlabbingo/home/di10huiopunrabo-bei-hou">https://sites.google.com/site/openlabbingo/home/di10huiopunrabo-bei-hou</a></li>
</ul>


<p>図らずも「いつか自分も発表できるようになりたい」と思っていたことが、たった1つのブログエントリから1年たたずに実現したわけです。しかしこれは運とかではなく、岡山周辺のIT勉強会コミュニティに、いろいろな人を登壇させていこうという風土のようなものが、ちゃんと根付いていたことの現れではないかと思っています。</p>

<p>そしてこの登壇あと、主催のYさんが唐突に「吉田さん、岡山でJavaのコミュニティやってくれない？」という話がありました。</p>

<p>聞けば、以前、岡山にはJavaのコミュニティがあったのですが、主催の方の転勤とともに開店休業状態にあるということ。そこで、自分にコミュニティの主催をやってみないか？ということでした。</p>

<p>今回が初登壇だった自分にいきなりそんなこと・・・とは、正直思いましたが、オープンラボ備後のYさんの勧めや、オープンラボ岡山の主催Hさんからもサポートしていただける、とのことだったので、岡山でJavaのコミュニティを始めることにしました。</p>

<p>幸いにも、自分ひとりでのスタートではなく、いつもScalaや関数型の話でみなをﾎﾟｶﾝとさせる<a href="https://twitter.com/razon">@razonさん</a>や、Twitterの裏垢で下ネタをつぶやいてばかりの<a href="https://twitter.com/ryosms">@ryosmsさん</a>、そして唯一？の常識人の<a href="https://twitter.com/o310yusuke">@o310yusukeさん</a>、などのこころ強い（？）メンバーの助けを借りつつ、岡山Javaユーザ会をスタートさせることになります。</p>

<p>その他にも助けて頂いた方はたくさんいますが、誰一人欠けても今までコミュニティを継続させることはできなかったと思います。</p>

<p>この場を借りて、関わった全ての皆様に深く感謝したいと思います。</p>

<h1>あなたはエンジニアの仕事、好きですか？</h1>

<p>ところで、あなたはエンジニアの仕事、好きですか？</p>

<p>エンジニアでない人、今の仕事好きですか？</p>

<p>私はエンジニアの仕事が大好きです。</p>

<p>自分はプログラマを目指して大学に入ったものの挫折し、その後のフリーター生活を経て、24歳の時に故郷に戻って運良くプログラマとして就職することができました。それから約16年。何事にも中途半端だった自分が、こうやって一つの仕事を続けてこられたのは、ひとえに「この仕事が好き」だからです。</p>

<p>だからこそ、このエンジニアという仕事を選んだ人たちが、楽しく仕事ができるようになればいいと思い、いままで岡山のIT勉強会コミュニティに関わってきました。</p>

<p>そしてその想いは、今でもかわることはありません。これからも岡山のIT勉強会コミュニティを影となって支えて参ります。</p>

<h1>the Future</h1>

<p>そしてもう一つ。来年に新しいことをスタートしようと考えています。</p>

<p>それが子供向けプログラミング教室です。</p>

<p>自分がはじめてプログラミングをしたのは、小学校の時に触れたファミリーベーシックでした。そこで説明書のプログラム通りに、右手の人差し指1本で、おぼつかない手でコードを書き、エラーを直し、実行し、そして画面でマリオが動いた時のあの感動。</p>

<p>この教室を通じて、自分が幼いときに感じた「自分で考え、自分で作って、動かす」そんな感動を子供たちに感じてもらい「プログラミングって楽しい！」と感じてくれる子供が一人でも増えてくれれば、これに勝る喜びはありません。</p>

<p>あくまでボランティアベースの教室になるので、塾のように授業料をもらうこともないです。なので成果を保証することもしません。子供たちがやりたいことを最優先に。やりたいことが見つからなければ、見つける手伝いから。</p>

<p>そして子供たちが「楽しかった、また来たい！」と思えるように。そんな空間を作れたらいいなと思っています。</p>

<p>既存のIT勉強会のコミュニティは、現役のエンジニアたちを支え、子供向けプログラミング教室が、未来のエンジニアを支える。</p>

<p>そしてこの両輪を回すことを、今後の自分の仕事として続けていけたら、と思っています。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/09/talk-about-crystal-on-gbdaitokai/">合同勉強会でCrystalの話をしてきた</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-09T17:24:39+09:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:24 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>これは<a href="http://www.adventar.org/calendars/800">Crystalアドベントカレンダー2015</a>の12/9のエントリです。</p>

<p>昨日は<a href="https://twitter.com/pine613">pine613</a>さんの<a href="https://gist.github.com/pine613/0e07a92660666508fc72">「Crystal-JP の活動紹介と、今後の活動について」</a>でした。</p>

<p>12/5に岡山県立大学にて行われた、<a href="https://gbdaitokai.doorkeeper.jp/events/31149">合同勉強会 in 大都会岡山 -2015 Winter-</a>にて、Crystalの紹介のセッションを行いました。</p>

<p>スライドはこちら。</p>

<script async class="speakerdeck-embed" data-id="964ceffc800542a8ae57ba44ca3c4d82" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script>


<p>主に伝えたかった内容としては</p>

<ul>
<li>CrystalはRubyistには簡単に使えます</li>
<li>Crystalは型があります</li>
<li>コンパイルして高速に実行できます</li>
</ul>


<p>といった3点を主題としました。</p>

<p>時間配分がいい感じだったので、実際にRubyでの実行速度と、Crystalでの実行速度の違いをデモすることができたのは、良かったのではないでしょうか。</p>

<p>途中うっかり「Rubyには型がないので云々」といったおかげで、現場の型警察のみなさんに</p>

<blockquote class="twitter-tweet" lang="ja"><p lang="ja" dir="ltr">型警察が登壇者を見守っています <a href="https://twitter.com/hashtag/gbdaitokai?src=hash">#gbdaitokai</a></p>&mdash; 人マン (@razon) <a href="https://twitter.com/razon/status/672989595659710464">2015, 12月 5</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>




<blockquote class="twitter-tweet" lang="ja"><p lang="ja" dir="ltr">「Rubyには型がないんですね」&#10;「「「いやあるあるあるある！」」」&#10;<a href="https://twitter.com/hashtag/gbdaitokai?src=hash">#gbdaitokai</a> <a href="https://twitter.com/hashtag/%E3%81%8A%E3%81%8B%E3%82%84%E3%81%BE%E3%81%93%E3%82%8F%E3%81%84?src=hash">#おかやまこわい</a></p>&mdash; mzsm@3日目東シ58a(てくぶ) (@mzsm_j) <a href="https://twitter.com/mzsm_j/status/672989634536673280">2015, 12月 5</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>となったのは迂闊でしたw</p>

<p>岡山の大きな勉強会で使う懇親会場に「座・スタジアム」というちょっと珍しい会場があります。</p>

<p><img src="/images/20151209/gbdaitokai.jpg" alt="screen" /></p>

<p>ここでLTしたいがために、東京、大阪からやってくる人もいるくらい、懇親会に最適な会場です。次はオープンセミナー岡山2016という勉強会がありますので、ぜひ県外の皆様にもお越しいただきたいですね。</p>

<ul>
<li>Togetter - <a href="http://togetter.com/li/908723">合同勉強会 in 大都会岡山 -2015 Winter- &amp; 忘年会議2015 まとめ #gbdaitokai #忘年会議</a></li>
<li>flickr - <a href="https://www.flickr.com/photos/zephiransas/albums/72157659745544384">合同勉強会 in 大都会岡山 -2015 Winter-</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/10/crystal-on-heroku/">CrystalをHerokuで動かしてみた</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-11-10T12:28:48+09:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:28 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近ちょっと話題のcrystal。これをHerokuで動かしてみました。</p>

<h2>Herokuの準備</h2>

<p>まずはHerokuにアプリケーションを作成します。</p>

<p>Herokuでは当然crystalをサポートしていませんので、crystalのコンパイラを自前でインストールする必要があります。
Herokuにはこういったことを実現するために、buildpackという仕組みが用意されています。</p>

<p>crystal用のbuildpackは既にあるので、今回はこれを利用します。</p>

<ul>
<li>zamith/heroku-buildpack-crystal - <a href="https://github.com/zamith/heroku-buildpack-crystal">https://github.com/zamith/heroku-buildpack-crystal</a></li>
</ul>


<p>heroku createする際に上記のbuildpackを指定しておきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>heroku create --buildpack https://github.com/zamith/heroku-buildpack-crystal
</span></code></pre></td></tr></table></div></figure>


<p>ちなみに、これはあとから指定することも可能です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>heroku
</span></code></pre></td></tr></table></div></figure>


<h2>アプリケーションの準備</h2>

<p>次にcrystalで簡単なWebサーバを実装します。といっても<a href="http://crystal-lang.org/">crystalの公式ページ</a>にあるサンプルに手を加えた簡単なものです。</p>

<p>app.crというファイル名で以下のファイルを準備します。</p>

<figure class='code'><figcaption><span>app.cr</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;http/server&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;option_parser&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">server_port</span> <span class="o">=</span> <span class="mi">8080</span>
</span><span class='line'><span class="no">OptionParser</span><span class="o">.</span><span class="n">parse!</span> <span class="k">do</span> <span class="o">|</span><span class="n">opts</span><span class="o">|</span>
</span><span class='line'>  <span class="n">opts</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;-p PORT&quot;</span><span class="p">,</span> <span class="s2">&quot;--port PORT&quot;</span><span class="p">,</span> <span class="s2">&quot;define port to run server&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">port</span><span class="o">|</span>
</span><span class='line'>    <span class="n">server_port</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">server</span> <span class="o">=</span> <span class="ss">HTTP</span><span class="p">:</span><span class="ss">:Server</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">server_port</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">request</span><span class="o">|</span>
</span><span class='line'>  <span class="ss">HTTP</span><span class="p">:</span><span class="ss">:Response</span><span class="o">.</span><span class="n">ok</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">,</span> <span class="s2">&quot;Hello world, got </span><span class="si">#{</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">!&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Listening on http://0.0.0.0:</span><span class="si">#{</span><span class="n">server_port</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="n">server</span><span class="o">.</span><span class="n">listen</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意するところは2点。</p>

<p>1点目は、option_parserを使って起動時のオプションでWebサーバのポート番号を指定できるようにしています。デフォルトでは8080ポートで起動します。</p>

<p>Herokuの場合、サーバのポートは$PORTの値を使用しなければいけませんので、起動時にその値を渡せるようにするためです。</p>

<p>2点目は、以下のようにServerのインスタンス生成時に"0.0.0.0"を指定することです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">server</span> <span class="o">=</span> <span class="ss">HTTP</span><span class="p">:</span><span class="ss">:Server</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">server_port</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">request</span><span class="o">|</span>
</span></code></pre></td></tr></table></div></figure>


<p>こうすることで、localhost以外からでもアクセス可能にしてあります。これを指定していない場合は、Herokuでの起動時に</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Error R10 <span class="o">(</span>Boot timeout<span class="o">)</span> -&gt; Web process failed to <span class="nb">bind </span>to <span class="nv">$PORT</span> within 60 seconds of launch
</span></code></pre></td></tr></table></div></figure>


<p>というエラーが発生します。</p>

<p>できたら早速、起動してみましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>crystal run app.cr
</span></code></pre></td></tr></table></div></figure>


<p>ブラウザからlocalhost:8080にアクセスし、以下の用に表示されれば、Webサーバが正しく起動しています。</p>

<p><img src="/images/20151110/screen.png" alt="screen" /></p>

<h2>その他のファイルの準備</h2>

<p>次にProcfileを以下のように準備します。</p>

<figure class='code'><figcaption><span>Procfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>web: ./app -p <span class="nv">$PORT</span>
</span></code></pre></td></tr></table></div></figure>


<p>起動時に$PORTをWebサーバのポートとして、指定しています。</p>

<p>次にProjectfileを準備します。中身は空でOKです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>touch Projectfile
</span></code></pre></td></tr></table></div></figure>


<p>これは本来は不要なファイルなのですが、crystalのbuildpack内でProjectfileがない場合は、crystalのアプリケーションとして認識してくれないため、空のファイルを作成しています。</p>

<h2>Herokuへデプロイ</h2>

<p>app.cr、Procfile、Projectfileの3つが準備できたら、Herokuにデプロイしてみましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git init
</span><span class='line'>git add .
</span><span class='line'>git commit -m <span class="s1">&#39;First commit&#39;</span>
</span><span class='line'>heroku git:remote --app <span class="o">[</span>APPNAME<span class="o">]</span>
</span><span class='line'>git push heroku master
</span></code></pre></td></tr></table></div></figure>


<p>あとは、Herokuにアクセスして、正しく動作していればOKです。</p>

<h2>まとめ</h2>

<p>今回作成したコードはこちらにおいてありますので、参考にしてください。</p>

<p><a href="https://github.com/zephiransas/crystal-heroku">https://github.com/zephiransas/crystal-heroku</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/29/unicorn-worker-killer/">Unicorn-worker-killerが便利だった件</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-29T15:57:26+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:57 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>自分が現在関わっているプロジェクトでは、nginx + unicornの構成で運用しているのですが、この構成でサーバのメモリが足りなくなるという現象に悩まされていました。</p>

<p>unicornのワーカプロセスは、通常では起動したままユーザからのリクエストを処理し、再起動されることはありません。
その関係で、長時間運用していると、そのワーカプロセスがメモリをあるだけ食いつぶすような挙動になります。</p>

<p>こんな時に便利なのが「<a href="https://github.com/kzk/unicorn-worker-killer">unicorn-worker-killer</a>」です。</p>

<p>unicorn-worker-killerを使うことで、ワーカプロセスが以下の条件の場合に、自動的に再起動してくれます。</p>

<ul>
<li>ワーカプロセスが指定回数のリクエストを処理した場合</li>
<li>ワーカプロセスが指定量のメモリを使用している場合</li>
</ul>


<p>いずれの場合でもワーカプロセスの再起動は、現在のリクエストを処理した後に再起動（いわゆるgraceful restart）されます。</p>

<h2>設定のしかた</h2>

<p>設定はconfig.ruにて行います。</p>

<h3>リクエストの回数基準で再起動する</h3>

<figure class='code'><figcaption><span>config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">use</span> <span class="ss">Unicorn</span><span class="p">:</span><span class="ss">:WorkerKiller</span><span class="o">::</span><span class="no">MaxRequests</span><span class="p">,</span> <span class="mi">3072</span><span class="p">,</span> <span class="mi">4096</span>
</span></code></pre></td></tr></table></div></figure>


<p>これはワーカプロセスが、3072回~4096回のいずれかの回数リクエストを処理したら再起動する設定です。</p>

<figure class='code'><figcaption><span>config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">use</span> <span class="ss">Unicorn</span><span class="p">:</span><span class="ss">:WorkerKiller</span><span class="o">::</span><span class="no">MaxRequests</span><span class="p">,</span> <span class="mi">3072</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>とすることで、unicorn.rbのstderr_pathで指定されたパスに状況を出力することができます。</p>

<h3>メモリの使用量を基準に再起動する</h3>

<figure class='code'><figcaption><span>config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">use</span> <span class="ss">Unicorn</span><span class="p">:</span><span class="ss">:WorkerKiller</span><span class="o">::</span><span class="no">Oom</span><span class="p">,</span> <span class="p">(</span><span class="mi">192</span><span class="o">*</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span> <span class="p">(</span><span class="mi">256</span><span class="o">*</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span> <span class="mi">16</span>
</span></code></pre></td></tr></table></div></figure>


<p>これはワーカプロセスが16回リクエストを処理する度に、自身のメモリ使用量をチェックし、これが192M~256Mのいずれかの使用量をオーバーしていた場合に、再起動する設定です。</p>

<h3>設定が2つある理由</h3>

<p>リクエスト回数とメモリ使用量の設定両方とも、しきい値を範囲で指定するようになっていますが、これには理由があります。</p>

<p>1つのしきい値だと、各ワーカが再起動するタイミングが、ほぼ同じになるからです。同じタイミングで全てのワーカプロセスが再起動してしまうと、その間リクエストを処理することができなくなってしまうので、これは好ましくありません。</p>

<p>ですので、しきい値を範囲で指定し、その範囲内のいずれかの値を実際のしきい値として採用するという仕組みになっています。</p>

<p>なので、しきい値の範囲は狭いより、広いほうが、ベターです。</p>

<h2>unicorn-worker-killerを試してみる</h2>

<p>では、unicorn-worker-killerがちゃんとワーカプロセスをKillできているかを確認してみます。</p>

<p>シナリオとしては</p>

<ul>
<li>config/unicorn.rbのworker_processesは1として、ワーカプロセスは1つだけにする</li>
<li>unicorn-worker-killerの設定は100回〜120回のリクエストを受けたタイミングで、ワーカプロセスを再起動するようにする</li>
</ul>


<p>まずはGemfileに</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;unicorn-worker-killer&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>と設定します。config.ruの設定は、以下のようになります。</p>

<figure class='code'><figcaption><span>config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">use</span> <span class="ss">Unicorn</span><span class="p">:</span><span class="ss">:WorkerKiller</span><span class="o">::</span><span class="no">MaxRequests</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>unicorn-worker-killerの詳細なログを出力するように設定しておきます。</p>

<p>この設定でunicornを起動します。すると以下ような感じでログが出力されます。</p>

<figure class='code'><figcaption><span>config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">31</span><span class="o">.</span><span class="mi">589102</span> <span class="c1">#29745]  INFO -- : worker=0 spawning...</span>
</span><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">31</span><span class="o">.</span><span class="mi">591242</span> <span class="c1">#29745]  INFO -- : master process ready</span>
</span><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">31</span><span class="o">.</span><span class="mi">593001</span> <span class="c1">#29752]  INFO -- : worker=0 spawned pid=29752</span>
</span><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">31</span><span class="o">.</span><span class="mi">593581</span> <span class="c1">#29752]  INFO -- : Refreshing Gem list</span>
</span><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">47</span><span class="o">.</span><span class="mo">035570</span> <span class="c1">#29752]  INFO -- : worker=0 ready</span>
</span></code></pre></td></tr></table></div></figure>


<p>pid=29752でワーカプロセスが1つ立ち上がりました。psで確認すると</p>

<figure class='code'><figcaption><span>config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">zephiransas</span> <span class="mi">29752</span> <span class="mi">30</span><span class="o">.</span><span class="mi">0</span>  <span class="mi">2</span><span class="o">.</span><span class="mi">8</span> <span class="mi">544708</span> <span class="mi">235984</span> <span class="o">?</span>       <span class="no">Sl</span>   <span class="mi">16</span><span class="p">:</span><span class="mi">38</span>   <span class="mi">0</span><span class="p">:</span><span class="mi">15</span> <span class="n">unicorn</span> <span class="n">worker</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">-</span><span class="n">c</span> <span class="n">config</span><span class="o">/</span><span class="n">unicorn</span><span class="o">.</span><span class="n">rb</span> <span class="o">-</span><span class="n">E</span> <span class="n">production</span> <span class="o">-</span><span class="n">D</span>
</span></code></pre></td></tr></table></div></figure>


<p>のような感じです。ここでブラウザから何度かアクセスすると、unicornのログに以下のように出力されます。</p>

<figure class='code'><figcaption><span>config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">37</span><span class="o">.</span><span class="mi">156111</span> <span class="c1">#29752]  INFO -- : #&lt;Unicorn::HttpServer:0x0000000343fa00&gt;: worker (pid: 29752) has 119 left before being killed</span>
</span><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">37</span><span class="o">.</span><span class="mi">349161</span> <span class="c1">#29752]  INFO -- : #&lt;Unicorn::HttpServer:0x0000000343fa00&gt;: worker (pid: 29752) has 118 left before being killed</span>
</span><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">37</span><span class="o">.</span><span class="mi">559274</span> <span class="c1">#29752]  INFO -- : #&lt;Unicorn::HttpServer:0x0000000343fa00&gt;: worker (pid: 29752) has 117 left before being killed</span>
</span><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">37</span><span class="o">.</span><span class="mi">649334</span> <span class="c1">#29752]  INFO -- : #&lt;Unicorn::HttpServer:0x0000000343fa00&gt;: worker (pid: 29752) has 116 left before being killed</span>
</span><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">47</span><span class="o">.</span><span class="mi">690545</span> <span class="c1">#29752]  INFO -- : #&lt;Unicorn::HttpServer:0x0000000343fa00&gt;: worker (pid: 29752) has 115 left before being killed</span>
</span></code></pre></td></tr></table></div></figure>


<p>pid=29752のワーカプロセスがあと何回リクエストを処理できるかが分かります。またリクエストするたびに1つづつ減っています。</p>

<p>では、引き続きブラウザからアクセスし、ワーカプロセスのメモリ使用状況を確認してみましょう。</p>

<figure class='code'><figcaption><span>config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">zephiransas</span> <span class="mi">29752</span>  <span class="mi">7</span><span class="o">.</span><span class="mi">1</span>  <span class="mi">3</span><span class="o">.</span><span class="mi">2</span> <span class="mi">785940</span> <span class="mi">269420</span> <span class="o">?</span>       <span class="no">Sl</span>   <span class="mi">16</span><span class="p">:</span><span class="mi">38</span>   <span class="mi">0</span><span class="p">:</span><span class="mi">26</span> <span class="n">unicorn</span> <span class="n">worker</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">-</span><span class="n">c</span> <span class="n">config</span><span class="o">/</span><span class="n">unicorn</span><span class="o">.</span><span class="n">rb</span> <span class="o">-</span><span class="n">E</span> <span class="n">production</span> <span class="o">-</span><span class="n">D</span>
</span></code></pre></td></tr></table></div></figure>


<p>メモリ使用量が少し増えているのがわかります。次にリクエストの残り回数を使い切り、ワーカプロセスが正しく再起動されるか確認します。</p>

<p>ブラウザからリクエストを投げ続けると、unicornのログに以下のように出力されます。</p>

<figure class='code'><figcaption><span>config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">W</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mi">539055</span> <span class="c1">#29752]  WARN -- : #&lt;Unicorn::HttpServer:0x0000000343fa00&gt;: worker (pid: 29752) exceeds max number of requests (limit: 119)</span>
</span><span class='line'><span class="n">W</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mi">539621</span> <span class="c1">#29752]  WARN -- : Unicorn::WorkerKiller send SIGQUIT (pid: 29752) alive: 383 sec (trial 1)</span>
</span><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mo">03</span><span class="o">.</span><span class="mi">467363</span> <span class="c1">#29745]  INFO -- : reaped #&lt;Process::Status: pid 29752 exit 0&gt; worker=0</span>
</span><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mo">03</span><span class="o">.</span><span class="mi">467928</span> <span class="c1">#29745]  INFO -- : worker=0 spawning...</span>
</span><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mo">03</span><span class="o">.</span><span class="mi">472507</span> <span class="c1">#7549]  INFO -- : worker=0 spawned pid=7549</span>
</span><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mo">03</span><span class="o">.</span><span class="mi">473377</span> <span class="c1">#7549]  INFO -- : Refreshing Gem list</span>
</span><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">19</span><span class="o">.</span><span class="mi">137831</span> <span class="c1">#7549]  INFO -- : worker=0 ready</span>
</span><span class='line'><span class="n">I</span><span class="p">,</span> <span class="o">[</span><span class="mi">2015</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span><span class="ss">T16</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">20</span><span class="o">.</span><span class="mi">251309</span> <span class="c1">#7549]  INFO -- : #&lt;Unicorn::HttpServer:0x0000000343fa00&gt;: worker (pid: 7549) has 101 left before being killed</span>
</span></code></pre></td></tr></table></div></figure>


<p>1行目でpid=29752がリクエスト回数上限の119回に達したことがわかります。</p>

<p>2行目ワーカプロセスに対してQUITシグナルを送信しています。</p>

<p>その後、別のワーカプロセスがpid=7549で起動しています。試しにpid=7549のメモリ使用量を見ると</p>

<figure class='code'><figcaption><span>config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">zephiransas</span>  <span class="mi">7549</span>  <span class="mi">5</span><span class="o">.</span><span class="mi">7</span>  <span class="mi">3</span><span class="o">.</span><span class="mi">1</span> <span class="mi">705752</span> <span class="mi">261532</span> <span class="o">?</span>       <span class="no">Sl</span>   <span class="mi">16</span><span class="p">:</span><span class="mi">47</span>   <span class="mi">0</span><span class="p">:</span><span class="mi">18</span> <span class="n">unicorn</span> <span class="n">worker</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">-</span><span class="n">c</span> <span class="n">config</span><span class="o">/</span><span class="n">unicorn</span><span class="o">.</span><span class="n">rb</span> <span class="o">-</span><span class="n">E</span> <span class="n">production</span> <span class="o">-</span><span class="n">D</span>
</span></code></pre></td></tr></table></div></figure>


<p>となり、以前より減っていることがわかります。</p>

<p>Railsアプリを実運用するときには必須のgemだと思います。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/08/eager-load-with-paranoia/">論理削除とeager_loadでN+1問題が発生する件</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-08T09:53:55+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:53 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Railsアプリにて論理削除とeager_loadを合わせて使うとN+1問題が発生することに気づいたのでメモ。</p>

<h2>N+1問題を確認する</h2>

<p>まずはN+1問題が起きるようなモデルを作成します。よくあるブログアプリのような、ブログのエントリがあり、それにコメントが複数あるパターンです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:title</span><span class="p">,</span>
</span><span class='line'>                  <span class="ss">:content</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:comments</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:post_id</span><span class="p">,</span>
</span><span class='line'>                  <span class="ss">:name</span><span class="p">,</span>
</span><span class='line'>                  <span class="ss">:content</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:post</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>適当なデータを入れた後、これに対してrails cで以下のようにレコードを取得します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Post</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>すると、以下のようなSQLが発行されます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Post</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;posts&quot;</span>
</span><span class='line'><span class="no">Comment</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;comments&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="s2">&quot;post_id&quot;</span> <span class="o">=</span> <span class="mi">12</span> <span class="no">LIMIT</span> <span class="mi">1</span>
</span><span class='line'><span class="err">ユーザ</span><span class="mi">1</span>
</span><span class='line'><span class="no">Comment</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;comments&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="s2">&quot;post_id&quot;</span> <span class="o">=</span> <span class="mi">13</span> <span class="no">LIMIT</span> <span class="mi">1</span>
</span><span class='line'><span class="err">ユーザ</span><span class="mi">1</span>
</span><span class='line'><span class="no">Comment</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;comments&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="s2">&quot;post_id&quot;</span> <span class="o">=</span> <span class="mi">14</span> <span class="no">LIMIT</span> <span class="mi">1</span>
</span><span class='line'><span class="err">ユーザ</span><span class="mi">1</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="err">（以下続く</span>
</span></code></pre></td></tr></table></div></figure>


<p>この場合は、<strong>対象となったPostの件数分、CommentsテーブルへのSQLが発行されることになります。</strong> これがN+1問題です。</p>

<h2>N+1問題に対処する</h2>

<p>これを解決するには、eager_loadを使うことが一般的です。つまり</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Post</span><span class="o">.</span><span class="n">eager_load</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>この場合のSQLは（一部簡略化しています）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="n">*</span><span class="p">,</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">*</span>
</span><span class='line'><span class="no">FROM</span> <span class="s2">&quot;posts&quot;</span> <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="s2">&quot;comments&quot;</span> <span class="no">ON</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="s2">&quot;post_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>となります。Postsテーブルと一緒にCommentsテーブルを取得しているので、SQLが1回だけ発行されていることがわかります。</p>

<p>美しい理想の世界です。ﾊﾗｼｮｰ</p>

<h2>paranoiaを導入する</h2>

<p>さて本題。ここで<strong>うっかり論理削除を導入</strong>してみましょう。</p>

<p>Railsには論理削除に関するgemは多数ありますが、現在のデファクトスタンダードは<a href="https://github.com/radar/paranoia">paranoia</a>だと思います。まずはparanoiaをGemfileに記述します。</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;paranoia&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 1.0&#39;</span>  <span class="c1"># Rails3系には1.0系を使用</span>
</span></code></pre></td></tr></table></div></figure>


<p>その後、モデルを以下のように変更します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">acts_as_paranoid</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:title</span><span class="p">,</span>
</span><span class='line'>                  <span class="ss">:content</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:comments</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">acts_as_paranoid</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:post_id</span><span class="p">,</span>
</span><span class='line'>                  <span class="ss">:name</span><span class="p">,</span>
</span><span class='line'>                  <span class="ss">:content</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:post</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>その後、eager_loadしてみます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Post</span><span class="o">.</span><span class="n">eager_load</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>するとSQLは以下の様に発行されます。（一部簡略化しています）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="n">*</span><span class="p">,</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">*</span>
</span><span class='line'><span class="no">FROM</span> <span class="s2">&quot;posts&quot;</span> <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="s2">&quot;comments&quot;</span> <span class="no">ON</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="s2">&quot;post_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span>
</span><span class='line'><span class="no">WHERE</span> <span class="p">(</span><span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="n">deleted_at</span> <span class="no">IS</span> <span class="no">NULL</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>PostsテーブルのWHERE条件にdeleted_at is nullが付与されているのは期待通りですが、Commentsテーブルには付与されていないので、これでは<strong>論理削除されたCommentsテーブルの内容</strong>も取得してしまいます・・・</p>

<p>では、以下のようにPostのcommentsにconditionsを付与するのはどうでしょう？</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">acts_as_paranoid</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:title</span><span class="p">,</span>
</span><span class='line'>                  <span class="ss">:content</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:comments</span><span class="p">,</span> <span class="ss">conditions</span><span class="p">:</span> <span class="s1">&#39;comments.deleted_at is null&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>ここで同様にeager_loadするとSQLは以下の様に発行されます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="n">*</span><span class="p">,</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">*</span>
</span><span class='line'><span class="no">FROM</span> <span class="s2">&quot;posts&quot;</span> <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="s2">&quot;comments&quot;</span> <span class="no">ON</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="s2">&quot;post_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AND</span> <span class="n">comments</span><span class="o">.</span><span class="n">deleted_at</span> <span class="n">is</span> <span class="n">null</span>
</span><span class='line'><span class="no">WHERE</span> <span class="p">(</span><span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="n">deleted_at</span> <span class="no">IS</span> <span class="no">NULL</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>WHERE条件が追加されて、なんだか、いい感じにeager_loadできました。</p>

<h2>論理削除したデータも取得したい場合</h2>

<p>さて、ここで少々頭がおかしくなって「削除したCommentも取りたい(^q^)」という気分になったとしましょう。</p>

<p>そこでPostクラスにcomments_with_deletedなるアソシエーションを追加します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">acts_as_paranoid</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:title</span><span class="p">,</span>
</span><span class='line'>                  <span class="ss">:content</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:comments</span><span class="p">,</span> <span class="ss">conditions</span><span class="p">:</span> <span class="s1">&#39;comments.deleted_at is null&#39;</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:comments_with_deleted</span><span class="p">,</span>
</span><span class='line'>           <span class="n">class_name</span><span class="p">:</span> <span class="s1">&#39;Comment&#39;</span><span class="p">,</span>
</span><span class='line'>           <span class="n">foreign_key</span><span class="p">:</span> <span class="ss">:post_id</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>さて、これを使ってeager_loadしてみましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Post</span><span class="o">.</span><span class="n">eager_load</span><span class="p">(</span><span class="ss">:comments_with_deleted</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>すると、以下のようなSQLが発行されます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="n">*</span><span class="p">,</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;posts&quot;</span> <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="s2">&quot;comments&quot;</span> <span class="no">ON</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="o">=</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">WHERE</span> <span class="p">(</span><span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="n">deleted_at</span> <span class="no">IS</span> <span class="no">NULL</span><span class="p">)</span>
</span><span class='line'><span class="no">Comment</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;comments&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="s2">&quot;post_id&quot;</span> <span class="o">=</span> <span class="mi">12</span> <span class="no">AND</span> <span class="p">(</span><span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">deleted_at</span> <span class="no">IS</span> <span class="no">NULL</span><span class="p">)</span> <span class="no">AND</span> <span class="p">(</span><span class="n">comments</span><span class="o">.</span><span class="n">deleted_at</span> <span class="n">is</span> <span class="n">null</span><span class="p">)</span> <span class="no">LIMIT</span> <span class="mi">1</span>
</span><span class='line'><span class="err">ユーザ</span><span class="mi">2</span>
</span><span class='line'><span class="no">Comment</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;comments&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="s2">&quot;post_id&quot;</span> <span class="o">=</span> <span class="mi">13</span> <span class="no">AND</span> <span class="p">(</span><span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">deleted_at</span> <span class="no">IS</span> <span class="no">NULL</span><span class="p">)</span> <span class="no">AND</span> <span class="p">(</span><span class="n">comments</span><span class="o">.</span><span class="n">deleted_at</span> <span class="n">is</span> <span class="n">null</span><span class="p">)</span> <span class="no">LIMIT</span> <span class="mi">1</span>
</span><span class='line'><span class="err">ユーザ</span><span class="mi">1</span>
</span><span class='line'><span class="no">Comment</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;comments&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="s2">&quot;post_id&quot;</span> <span class="o">=</span> <span class="mi">14</span> <span class="no">AND</span> <span class="p">(</span><span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">deleted_at</span> <span class="no">IS</span> <span class="no">NULL</span><span class="p">)</span> <span class="no">AND</span> <span class="p">(</span><span class="n">comments</span><span class="o">.</span><span class="n">deleted_at</span> <span class="n">is</span> <span class="n">null</span><span class="p">)</span> <span class="no">LIMIT</span> <span class="mi">1</span>
</span><span class='line'><span class="err">ユーザ</span><span class="mi">1</span>
</span><span class='line'><span class="no">Comment</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;comments&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="s2">&quot;post_id&quot;</span> <span class="o">=</span> <span class="mi">15</span> <span class="no">AND</span> <span class="p">(</span><span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">deleted_at</span> <span class="no">IS</span> <span class="no">NULL</span><span class="p">)</span> <span class="no">AND</span> <span class="p">(</span><span class="n">comments</span><span class="o">.</span><span class="n">deleted_at</span> <span class="n">is</span> <span class="n">null</span><span class="p">)</span> <span class="no">LIMIT</span> <span class="mi">1</span>
</span><span class='line'><span class="err">ユーザ</span><span class="mi">1</span>
</span><span class='line'><span class="no">Comment</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;comments&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="s2">&quot;post_id&quot;</span> <span class="o">=</span> <span class="mi">16</span> <span class="no">AND</span> <span class="p">(</span><span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">deleted_at</span> <span class="no">IS</span> <span class="no">NULL</span><span class="p">)</span> <span class="no">AND</span> <span class="p">(</span><span class="n">comments</span><span class="o">.</span><span class="n">deleted_at</span> <span class="n">is</span> <span class="n">null</span><span class="p">)</span> <span class="no">LIMIT</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>最初のSQLでは、条件にcomments.deleted_at is nullが付与されていないので、これは期待通りなのですが、<strong>その後、なぜかN+1問題が再発</strong>しています。</p>

<p><del>現在のところ、これを回避できる方法は見つけられていません。</del></p>

<ul>
<li>追記</li>
</ul>


<p>我らのひむひむセンセイから、アドバイスを頂きました。</p>

<blockquote class="twitter-tweet" lang="ja"><p lang="ja" dir="ltr"><a href="https://twitter.com/zephiransas">@zephiransas</a> &#10;Post.eager_load(:comments_with_deleted).each do |post|&#10; puts <a href="http://t.co/FVIFkHFf3H">http://t.co/FVIFkHFf3H</a>&#10;end&#10;的な感じじゃダメなんかね <a href="https://twitter.com/hashtag/%E3%81%A6%E3%81%8D%E3%81%A8%E3%81%86?src=hash">#てきとう</a></p>&mdash; えいる (@eielh) <a href="https://twitter.com/eielh/status/618621108854652929">2015, 7月 8</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>なるほど！やってみましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Post</span><span class="o">.</span><span class="n">eager_load</span><span class="p">(</span><span class="ss">:comments_with_deleted</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="n">post</span><span class="o">.</span><span class="n">comments_with_deleted</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>するとSQLは</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SELECT</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span>
</span><span class='line'><span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="n">*</span><span class="p">,</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;posts&quot;</span> <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span>
</span><span class='line'><span class="no">ON</span> <span class="s2">&quot;comments&quot;</span><span class="o">.</span><span class="s2">&quot;post_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span>
</span><span class='line'><span class="no">WHERE</span> <span class="p">(</span><span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="n">deleted_at</span> <span class="no">IS</span> <span class="no">NULL</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>となって、意図した結果になりましたとさ。</p>

<p>でもこれ、実装時に意識しながら書ける自信ないですわ・・・(´・3・`)</p>

<h2>結論</h2>

<p>結論を<a href="http://blog.oukasoft.com/OS/">社畜ちゃん</a>にまとめていただきます。</p>

<p><img src="/images/20150708/summary.png" alt="summary" /></p>

<p>とは言っても論理武装が必要でしょうから、こちらも合わせてどうぞ。</p>

<ul>
<li>DELETE_FLAG を付ける前に確認したいこと。 - <a href="http://qiita.com/Jxck_/items/156d0a231c6968f2a474">http://qiita.com/Jxck_/items/156d0a231c6968f2a474</a></li>
<li>論理削除が云々について - <a href="http://mike-neck.hatenadiary.com/entry/2015/03/24/231422">http://mike-neck.hatenadiary.com/entry/2015/03/24/231422</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
<section>
  <h1>About Me</h1>
  <img style="display:block;float:left;" src="http://www.gravatar.com/avatar/ab963de01b53e635d6e699d6d7d162b1" alt="Gravatar of Takafumi Yoshida (@zephiransas) " title="Gravatar of Takafumi Yoshida (@zephiransas)" />
  <p>
    Takafumi Yoshida<br/>
    Java/Ruby/Scala<br/>
    Programmer at Okayama<br/>
    <a href="http://twitter.com/zephiransas">@zephiransas</a>
  </p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/04/05/gulp-sass/">Spring BootのCSSをGulpで管理する</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/03/10/ciecleci-and-gradle/">CircleCIでGradleのテストを並列実行する</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/31/schfeslogsvr/">スクフェス・ログサーバをつくった</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/18/gbdaitokai2016/">合同勉強会2016に参加してきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/23/maven-wrapper/">Maven Wrapperを使ってプロジェクトで使うMavenのバージョンを指定する</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/zephiransas">@zephiransas</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'zephiransas',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Takafumi Yoshida (@zephiransas) -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
